# Installs and runs Podman on macOS-based agents
name: '$(SourceBranchName)_$(Date:yyyyMMdd).$(Rev:rrr)'

resources:
  repositories:
  - repository: 'aspnet_core_logging'
    type: 'github'
    name: 'satrapu/aspnet-core-logging'
    clean: True
    endpoint: 'satrapu'

trigger: none

jobs:
- job: run_containers_via_podman
  displayName: Run containers via Podman
  continueOnError: False
  pool:
    vmImage: 'macOS-11'
  workspace:
    clean: all
  steps:
  - checkout: self
    clean: True
    fetchDepth: 1
    lfs: False

  - script: |
      echo 'Installing QEMU machine emulator and visualizer ...'
      brew install qemu
      echo 'QEMU has been installed'

      echo 'Installing Podman ...'
      brew install podman
      echo 'Podman has been installed'
      
      # Creates a new Linux VM (having 2 CPUs, 1GB of RAM and 1GB of disk) to host containers
      # See more about 'podman machine init' command here: https://docs.podman.io/en/latest/markdown/podman-machine-init.1.html.
      echo 'Creating a Podman machine to host containers ...'
      podman machine init --cpus=2 --memory=1024 --disk-size=1 myvm
      echo 'Podman machine has been created'

      echo 'Listing all available Podman machines ...'
      podman machine list

      echo 'Starting Podman machine ...'
      podman machine start myvm
      echo 'Podman machine has been started'
