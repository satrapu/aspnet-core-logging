# Installs and runs Podman on macOS-based agents
name: '$(SourceBranchName)_$(Date:yyyyMMdd).$(Rev:rrr)'

resources:
  repositories:
  - repository: 'aspnet_core_logging'
    type: 'github'
    name: 'satrapu/aspnet-core-logging'
    clean: True
    endpoint: 'satrapu'

trigger: none

jobs:
- job: run_containers_via_podman
  displayName: Run containers via Podman
  continueOnError: False
  pool:
    vmImage: 'macOS-11'
  workspace:
    clean: all
  steps:
  - checkout: self
    clean: True
    fetchDepth: 1
    lfs: False

  - script: |
      # Install qemu machine emulator and visualizer view brew
      brew install qemu

      # Install Podman client on via brew
      brew install podman
      
      # Creates a new Linux VM (having 2 CPUs, 1GB of RAM and 1GB of disk) to host containers
      # See more about 'podman machine init' command here: https://docs.podman.io/en/latest/markdown/podman-machine-init.1.html.
      podman machine init --cpus=2 --memory=1024 --disk-size=1 myvm
      podman machine list
      podman machine start myvm
